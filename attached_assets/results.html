<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forecast Results | Smart Demand Forecast</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <div class="container animated">
    <div class="header">
      <h1><i class="fas fa-chart-bar forecast-icon"></i> Forecast Results</h1>
      <p class="text-muted">Analysis for {{ product }}</p>
    </div>
    
    <div class="card">
      <div class="card-header">
        <h2 class="text-white mb-0">Inventory Recommendations</h2>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="list-group">
              <div class="list-group-item">
                <strong><i class="fas fa-box-open me-2"></i>Order Quantity:</strong> 
                <span class="float-end">{{ order_quantity }}</span>
              </div>
              <div class="list-group-item">
                <strong><i class="fas fa-arrow-circle-down me-2"></i>Reorder Point:</strong> 
                <span class="float-end">{{ reorder_point }}</span>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="list-group">
              <div class="list-group-item">
                <strong><i class="fas fa-shield-alt me-2"></i>Safety Stock:</strong> 
                <span class="float-end">{{ safety_stock }}</span>
              </div>
              <div class="list-group-item">
                <strong><i class="fas fa-rupee-sign me-2"></i>Total Cost:</strong> 
                <span class="float-end">â‚¹{{ total_cost }}</span>
              </div>
            </div>
          </div>
        </div>

        {% if show_graph %}
        <div class="mt-5">
          <h4 class="text-center mb-4">
            <i class="fas fa-chart-line me-2"></i>Demand Forecast Visualization
          </h4>
          <div id="forecastChart" class="mt-3"></div>
          <script>
            (function() {
              try {
                // Get data passed from Flask
                const historicalData = JSON.parse('{{ historical_data | tojson | safe }}');
                const forecastData = JSON.parse('{{ forecast_data | tojson | safe }}');

                // Create figure
                const fig = {
                  data: [
                    {
                      x: historicalData.map(d => d[0]),
                      y: historicalData.map(d => d[1]),
                      name: 'Historical Demand',
                      mode: 'lines+markers',
                      line: {color: '#4285F4', width: 2},
                      marker: {size: 6}
                    },
                    {
                      x: forecastData.map(d => d[0]),
                      y: forecastData.map(d => d[1]),
                      name: 'Forecast',
                      mode: 'lines+markers',
                      line: {color: '#EA4335', width: 2, dash: 'dot'},
                      marker: {size: 6, symbol: 'diamond'}
                    }
                  ],
                  layout: {
                    title: {
                      text: `Demand Forecast for {{ product }}`,
                      font: {size: 18}
                    },
                    xaxis: {
                      title: 'Date',
                      showgrid: true,
                      gridcolor: '#f0f0f0'
                    },
                    yaxis: {
                      title: 'Demand',
                      showgrid: true,
                      gridcolor: '#f0f0f0'
                    },
                    hovermode: 'x unified',
                    showlegend: true,
                    legend: {
                      orientation: 'h',
                      y: 1.1,
                      font: {size: 12}
                    },
                    plot_bgcolor: 'rgba(240,240,240,0.8)',
                    margin: {t: 50, b: 50, l: 50, r: 50},
                    width: 1000,
                    height: 600
                  }
                };

                // Render plot
                Plotly.newPlot('forecastChart', fig.data, fig.layout);
                
                // Add hover effects
                document.getElementById('forecastChart').on('plotly_hover', function(data) {
                  const point = data.points[0];
                  console.log('Hovered over:', point);
                });

              } catch (error) {
                console.error("Error rendering plot:", error);
                document.getElementById('forecastChart').innerHTML = 
                  '<div class="alert alert-danger">' +
                  '<i class="fas fa-exclamation-triangle me-2"></i>' +
                  'Error loading visualization: ' + error.message +
                  '<br>Check browser console (F12) for details' +
                  '</div>';
              }
            })();
          </script>
        </div>
        {% endif %}

        <div class="d-flex justify-content-between mt-5">        
          <a href="/" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back
          </a>
          <a href="data:text/csv;charset=utf-8,{{ csv_data | urlencode }}" 
             class="btn download-btn" 
             download="{{ product }}_forecast.csv">
            <i class="fas fa-file-csv me-2"></i>Download CSV
          </a>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
